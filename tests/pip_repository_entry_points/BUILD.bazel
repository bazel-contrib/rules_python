load("@pip_installed//:requirements.bzl", installed_entry_point = "entry_point", installed_entry_point_binary = "entry_point_binary")
load("@pip_parsed//:requirements.bzl", parsed_entry_point = "entry_point", parsed_entry_point_binary = "entry_point_binary")
load("@rules_python//python:defs.bzl", "py_test")
load("@rules_python//python:pip.bzl", "compile_pip_requirements")

# This rule adds a convenient way to update the requirements file.
compile_pip_requirements(
    name = "requirements",
    extra_args = ["--allow-unsafe"],
    requirements_windows = ":requirements_windows.txt",
)

pip_parsed_sphinx = parsed_entry_point(
    pkg = "sphinx",
    script = "sphinx-build",
)

parsed_entry_point_binary(
    name = "pip_parsed_sphinx_binary",
    pkg = "sphinx",
    script = "sphinx-build",
)

pip_parsed_yamllint = parsed_entry_point("yamllint")

parsed_entry_point_binary(
    name = "pip_parsed_yamllint_binary",
    pkg = "yamllint",
)

py_test(
    name = "pip_parse_entry_points_test",
    srcs = ["pip_repository_entry_points_test.py"],
    data = [
        pip_parsed_sphinx,
        ":pip_parsed_sphinx_binary",
        pip_parsed_yamllint,
        ":pip_parsed_yamllint_binary",
    ],
    env = {
        "SPHINX_BUILD_ENTRY_POINT": "$(rootpath {})".format(pip_parsed_sphinx),
        "SPHINX_BUILD_ENTRY_POINT_BINARY": "$(rootpath :pip_parsed_sphinx_binary)",
        "YAMLLINT_ENTRY_POINT": "$(rootpath {})".format(pip_parsed_yamllint),
        "YAMLLINT_ENTRY_POINT_BINARY": "$(rootpath :pip_parsed_yamllint_binary)",
    },
    main = "pip_repository_entry_points_test.py",
    deps = ["@rules_python//python/runfiles"],
)

pip_installed_sphinx = installed_entry_point(
    pkg = "sphinx",
    script = "sphinx-build",
)

installed_entry_point_binary(
    name = "pip_installed_sphinx_binary",
    pkg = "sphinx",
    script = "sphinx-build",
)

pip_installed_yamllint = installed_entry_point("yamllint")

installed_entry_point_binary(
    name = "pip_installed_yamllint_binary",
    pkg = "yamllint",
)

py_test(
    name = "pip_install_annotations_test",
    srcs = ["pip_repository_entry_points_test.py"],
    data = [
        pip_installed_sphinx,
        ":pip_installed_sphinx_binary",
        pip_installed_yamllint,
        ":pip_installed_yamllint_binary",
    ],
    env = {
        "SPHINX_BUILD_ENTRY_POINT": "$(rootpath {})".format(pip_installed_sphinx),
        "SPHINX_BUILD_ENTRY_POINT_BINARY": "$(rootpath :pip_installed_sphinx_binary)",
        "YAMLLINT_ENTRY_POINT": "$(rootpath {})".format(pip_installed_yamllint),
        "YAMLLINT_ENTRY_POINT_BINARY": "$(rootpath :pip_installed_yamllint_binary)",
    },
    main = "pip_repository_entry_points_test.py",
    deps = ["@rules_python//python/runfiles"],
)
